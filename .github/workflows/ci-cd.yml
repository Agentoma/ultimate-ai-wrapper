name: CI/CD - Ultimate AI Wrapper Automation

# Triggers - Multiple automation scenarios
on:
  # Trigger on every push to main
  push:
    branches: [ main ]
  
  # Trigger on pull requests
  pull_request:
    branches: [ main ]
  
  # Trigger daily at 2 AM UTC (automated maintenance)
  schedule:
    - cron: '0 2 * * *'
  
  # Manual trigger from GitHub UI
  workflow_dispatch:
  
  # Trigger when issues are created/updated
  issues:
    types: [opened, labeled]

jobs:
  # Job 1: Code Quality & Validation
  validate:
    name: Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Validate manifest.json
      run: |
        echo "ğŸ” Validating manifest.json..."
        cat manifest.json | python3 -m json.tool > /dev/null
        echo "âœ… Manifest is valid JSON"
    
    - name: Check file structure
      run: |
        echo "ğŸ“ Checking required files..."
        test -f manifest.json && echo "âœ… manifest.json found"
        test -f README.md && echo "âœ… README.md found"
        test -d content && echo "âœ… content/ directory found"
        test -d background && echo "âœ… background/ directory found"
    
    - name: Check JavaScript syntax
      run: |
        echo "ğŸ” Checking JavaScript syntax..."
        node --check background/service-worker.js
        node --check content/sidebar.js
        echo "âœ… No syntax errors"
    
    - name: Count lines of code
      run: |
        echo "ğŸ“Š Code Statistics:"
        echo "Total lines: $(find . -name '*.js' -o -name '*.html' -o -name '*.css' | xargs wc -l | tail -1)"
        echo "JavaScript: $(find . -name '*.js' | xargs wc -l | tail -1)"
        echo "HTML: $(find . -name '*.html' | xargs wc -l | tail -1)"

  # Job 2: Security Scanning
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check for sensitive data
      run: |
        echo "ğŸ” Scanning for sensitive data..."
        ! grep -r "password" . --include="*.js" || echo "âš ï¸  Found 'password' references"
        ! grep -r "api_key" . --include="*.js" || echo "âš ï¸  Found 'api_key' references"
        ! grep -r "secret" . --include="*.js" || echo "âš ï¸  Found 'secret' references"
        echo "âœ… Security scan complete"
    
    - name: Verify permissions
      run: |
        echo "ğŸ”’ Checking manifest permissions..."
        grep -q '"permissions"' manifest.json && echo "âœ… Permissions declared"
        grep -q '"host_permissions"' manifest.json && echo "âœ… Host permissions declared"

  # Job 3: Build & Package
  build:
    name: Build Extension
    runs-on: ubuntu-latest
    needs: [validate, security]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Create build directory
      run: |
        echo "ğŸ“¦ Creating build package..."
        mkdir -p build
        cp -r . build/
        cd build
        rm -rf .git .github build
    
    - name: Generate build info
      run: |
        echo "â„¹ï¸  Build Information:"
        echo "Build Date: $(date)"
        echo "Commit SHA: ${{ github.sha }}"
        echo "Branch: ${{ github.ref_name }}"
        echo "Actor: ${{ github.actor }}"
    
    - name: Create ZIP archive
      run: |
        cd build
        zip -r ../ultimate-ai-wrapper.zip .
        cd ..
        ls -lh ultimate-ai-wrapper.zip
        echo "âœ… Extension packaged successfully"
    
    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: extension-build
        path: ultimate-ai-wrapper.zip
        retention-days: 30

  # Job 4: Documentation Check
  docs:
    name: Documentation Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check README completeness
      run: |
        echo "ğŸ“š Validating documentation..."
        grep -q "Installation" README.md && echo "âœ… Installation section found"
        grep -q "Usage" README.md && echo "âœ… Usage section found"
        grep -q "Features" README.md && echo "âœ… Features section found"
        echo "âœ… Documentation check complete"
    
    - name: Check for LICENSE
      run: |
        if [ -f LICENSE ]; then
          echo "âœ… LICENSE file present"
        else
          echo "âš ï¸  No LICENSE file found"
        fi

  # Job 5: Test Extension Load
  test:
    name: Extension Load Test
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Validate extension structure
      run: |
        echo "ğŸ§ª Testing extension structure..."
        test -f manifest.json || exit 1
        grep -q '"manifest_version": 3' manifest.json && echo "âœ… Using Manifest V3"
        grep -q '"name"' manifest.json && echo "âœ… Extension name found"
        grep -q '"version"' manifest.json && echo "âœ… Version found"
        echo "âœ… Extension structure valid"

  # Job 6: Dependency Update Check
  update-check:
    name: Dependency Update Check
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check for updates
      run: |
        echo "ğŸ”„ Checking for potential updates..."
        echo "âœ… Chrome Extension Manifest V3 - Current"
        echo "ğŸ“Œ Repository is up to date"

  # Job 7: Issue Auto-Labeler
  auto-label:
    name: Auto-label Issues
    runs-on: ubuntu-latest
    if: github.event_name == 'issues'
    
    steps:
    - name: Add labels to new issues
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.addLabels({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            labels: ['triage', 'needs-review']
          })

  # Job 8: Notification
  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [build]
    if: success()
    
    steps:
    - name: Success notification
      run: |
        echo "ğŸ‰ ========================================"
        echo "âœ… ALL CHECKS PASSED!"
        echo "ğŸš€ Ultimate AI Wrapper CI/CD Complete"
        echo "ğŸ“… Date: $(date)"
        echo "ğŸ”— Repository: ${{ github.repository }}"
        echo "ğŸ¯ Commit: ${{ github.sha }}"
        echo "========================================"
